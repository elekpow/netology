# Домашнее задание к занятию «Резервное копирование баз данных» <br/> Игорь Левин

---

### Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. 

Необходимо описать, какие варианты резервного копирования подходят в случаях: 

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

*Приведите ответ в свободной форме.*


---

**Выполнение задания 1.**


- Кейс 1.1 Для восстановления данных в полном объеме за предыдущий день, необходимо осуществить Полное резервное копирование, однако это требует значительного пространства для хранения и
больше времени для восстановления.  Также применяют инкрементное резервного копирование, при использовании этого метода создается полная копия данных только в первый раз,а затем создаются последующие инкрементные копии измененных или новых файлов. 

Резервное копирование лучше осуществлять ежедневно во вне рабочее время (ночью), когда нагрузка на сеть и серверное оборудование минимальное. Полное резервное копирование один раз в неделю в воскресенье.

Для восстановления данных в полном объеме лучше всего использовать Дифференциальный бэкап, отличающийся от инкрементального в том что подсчет изменений идет от полной копии данных. В нём будут находиться только недавно добавленные и измененные данные с момента последнего полного резервного копирования, то есть за предыдущий день. 



- Кейс 1.2 Если необходимо восстанавить данные за час до предполагаемой поломки, то в этом случае необходимо что бы осуществлялось непрерывное резервное копирование. Метод позволил бы резервировать данные на постоянной основе, практически в режиме реального времени. Также можно делать частые резервные копии, например критически важные данные  с краткими интервалами времени. 
Пременение дифференциальных и инкрементальных бэкапов позволило бы ускорить восстановние данных. 

Полное резервное копирование осущесвтвляется еженедельно, также каждый час выполняется  инкрементальное и каждую ночь диференциальное. 

Для восстановления данных понадобиться полная копия а также диференциальная за этот день и все инкрементые до этого часа.


- Кейс 1.3* Применение сервера для репликации базы данных, позволит переключиться на рабочую базу данных. В то время может быть осуществлен ремнот и восстановление основного сервера. 


---

### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

*Приведите ответ в свободной форме.*

---

**Выполнение задания 2.**


2.1. PostgreSQL — это объектно-реляционная система управления базами данных.


**PostgreSQL, создание резервных копий:**

Создание дампа базы данных:

```
pg_dump <parametrs> <db_name> > "path/file.dump"
```

Выгрузка отдельной таблицы mytab:
```
pg_dump -t "mytab" <db_name> > "path/file.dump"
```

**Восстановление базы данных:**

```
pg_restore -d postgres --clean --create db.dump

```

**-d — имя базы данных.**
**-clean — добавление операторов DROP перед операторами CREATE.**


Восстановить определнную таблицу базы данных:
```
pg_restore -a -t tbl "path/file.dump"
```

---

### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL. 

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

*Приведите ответ в свободной форме.*

---

**Выполнение задания 3.**


Инкрементное резервное копирование MySQL:

**настройка mysql log**
```
[mysqld]
bind-address    = 127.0.0.1
server-id       = 1
log_bin         = /var/log/mysql/mysql-bin.log
expire_logs_days = 10
```

1) Создадим базу данных **'test'** и в ней таблицу **'Users'**

```sql
CREATE database test; 
USE test;
CREATE table test.users( id INT AUTO_INCREMENT PRIMARY KEY, FirstName VARCHAR(30));
```

2) В базе данных появилась таблица **users**

```sql
mysql -uroot -p

SHOW databases;
SHOW tables FROM test;
USE test; 
SELECT * FROM users;
```

 ![img1.JPG](https://github.com/elekpow/netology/blob/main/reldb/lesson8/images/img1.JPG)

3) запишем в таблицу не сколько значений

```sql
mysql -uroot -p

USE test; 
INSERT INTO users(FirstName) VALUES ("User1"),("User2"),("User3"),("User4");

```
 ![img2.JPG](https://github.com/elekpow/netology/blob/main/reldb/lesson8/images/img2.JPG)
 
4) создадим полный бекап базы данных

выходим из консоли mysql `$mysql> \q` и воспользуемся утилитой `mysqldump` с помощью которой получим дамп содержимого базы данных.

```sql
mkdir ./dump

mysqldump -v -uroot -p --databases test --single-transaction --flush-logs --source-data=2 > ./dump/full_backup.sql

ls -la ./dump/

```

при создании полного бекапа используем флаг ** --flush-logs**, он закроет текущий журнал например:(mysql-bin.000001) и создаст новый (mysql-bin.000002).


 ![img3.JPG](https://github.com/elekpow/netology/blob/main/reldb/lesson8/images/img3.JPG)


5) Очистим log

```sql
mysqladmin -uroot -p flush-logs

```
в данном случае имеем журнал **mysql-bin.000019**

если внести данные , то они запишуться в новый журнал **mysql-bin.000019**

```sql
mysql -uroot -p -e 'USE test; INSERT INTO users(FirstName) VALUES ("User_new_1"),("User_new_2"),("User_new_3");'
```


повторив  выполнение `flush-logs` мы запишем данные в следующий журнал , тем самым каждый журнал  будет содержать только новые данные.


посмотрим вновь созданые журналы:

```sql
ls -la /var/log/mysql/
```

 ![img4.JPG](https://github.com/elekpow/netology/blob/main/reldb/lesson8/images/img4.JPG)



6) восстановление данных 

Удаляем базу данных 

```sql
mysql -uroot -p -e 'drop database test;'

```

Восстановливаем данные из полной копии:

**создаем базу данных **

`mysql -uroot -p -e 'CREATE database test; SHOW databases;'`

**восстанавливаем полную копию**

`mysql -u root -p test < ./dump/full_backup.sql`

проверим базу данных, подключимся к MySQL `mysql -uroot -p`

`mysql -uroot -p -e 'USE test; SELECT * FROM users;'`


 ![img5.JPG](https://github.com/elekpow/netology/blob/main/reldb/lesson8/images/img5.JPG)
 
 Восстановление данных MySQL из двоичного журнала, сохраненного в файле mysql-bin.000019.

**Инкрементная резервная копия**

```sql
ls -la /var/log/mysql/

mysqlbinlog /var/log/mysql/mysql-bin.000019 | mysql -uroot -p test

```

 ![img6.JPG](https://github.com/elekpow/netology/blob/main/reldb/lesson8/images/img6.JPG)





3.1.* 

Использование реплики имеет преимущества по сравнению с обычным резервным копированием. Реплика создает дополнительную копию данных на отдельной системе или устройстве хранения, что уменьшает риск потери данных в случае сбоя или повреждения основной системы. А также позволяет обеспечить непрерывность работы системы даже во время проведения обслуживания. В случае сбоя или потери данных можно мгновенно переключиться на реплику и продолжить работу.



---
